<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data Ziarah Komusla</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Background putih murni untuk seluruh body */
        body { 
            background-color: #ffffff; 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            color: #1a1a1a;
        }
        
        /* Status dengan warna solid tanpa transparansi */
        .status-lunas { 
            background-color: #10b981; 
            color: #ffffff; 
            border: none; 
        }
        .status-belum { 
            background-color: #ef4444; 
            color: #ffffff; 
            border: none; 
        }
        
        .admin-panel { display: none; }
        .is-admin .admin-panel { display: block; }
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; display: flex; justify-content: center;
            align-items: center; z-index: 100;
        }

        /* Penegasan Font sesuai permintaan sebelumnya */
        .header-bold { 
            font-weight: 900 !important; 
            color: #000000 !important;
            background-color: #f9fafb; /* Abu sangat muda untuk pemisah header */
        }
        
        .row-nama { font-weight: 800; color: #000000; }
        .row-nominal { font-weight: 700; color: #1a1a1a; }
        
        /* Border solid untuk tabel */
        table { border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="pb-20">

    <!-- Loading Screen -->
    <div id="loader">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-black font-bold text-xs uppercase tracking-widest">Sinkronisasi Cloud...</p>
        </div>
    </div>

    <!-- Header Biru Solid -->
    <header class="bg-blue-800 text-white py-8 shadow-sm mb-8">
        <div class="container mx-auto px-4 flex justify-between items-center max-w-5xl">
            <div>
                <h1 class="text-2xl font-black uppercase tracking-tighter">PESERTA ZIARAH KOMUSLA</h1>
                <p class="text-[10px] font-medium tracking-widest opacity-90 mt-1">by Reydns Oficial</p>
            </div>
            <button id="authBtn" class="bg-white text-blue-800 px-6 py-2 rounded-full font-black text-xs hover:bg-gray-100 transition-all uppercase tracking-wider">
                LOGIN ADMIN
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 max-w-5xl">
        
        <!-- Dashboard Statistik - Latar Putih Solid dengan Border -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-xl border-2 border-gray-100 shadow-sm">
                <p class="text-[10px] text-gray-500 font-black uppercase tracking-widest mb-1">Total Peserta</p>
                <h3 id="statTotal" class="text-3xl font-black text-black">0</h3>
            </div>
            <div class="bg-white p-6 rounded-xl border-2 border-gray-100 shadow-sm">
                <p class="text-[10px] text-gray-500 font-black uppercase tracking-widest mb-1">Total Terbayar</p>
                <h3 id="statDana" class="text-3xl font-black text-green-600">Rp 0</h3>
            </div>
            <div class="bg-white p-6 rounded-xl border-2 border-gray-100 shadow-sm">
                <p class="text-[10px] text-gray-500 font-black uppercase tracking-widest mb-1">Kekurangan</p>
                <h3 id="statSisa" class="text-3xl font-black text-red-600">Rp 0</h3>
            </div>
        </div>

        <!-- Form Input Admin -->
        <div id="formSection" class="admin-panel mb-10">
            <div class="bg-white p-8 rounded-xl border-2 border-blue-600">
                <h2 class="text-sm font-black mb-6 text-blue-800 uppercase tracking-widest border-b-2 border-blue-50 py-2">Tambah Peserta</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Nama Lengkap</label>
                        <input type="text" id="inNama" class="w-full p-3 border-2 border-gray-100 rounded-lg outline-none focus:border-blue-600 font-bold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Alamat/Domisili</label>
                        <input type="text" id="inAlamat" class="w-full p-3 border-2 border-gray-100 rounded-lg outline-none focus:border-blue-600 font-bold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Harga Tiket Bus</label>
                        <input type="number" id="inTagihan" value="250000" class="w-full p-3 border-2 border-gray-100 rounded-lg outline-none focus:border-blue-600 font-bold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Pembayaran Awal</label>
                        <input type="number" id="inBayar" value="0" class="w-full p-3 border-2 border-gray-100 rounded-lg outline-none focus:border-blue-600 font-bold">
                    </div>
                </div>
                <button id="btnSimpan" class="mt-8 w-full bg-blue-800 text-white font-black py-4 rounded-lg hover:bg-black transition-all uppercase text-xs tracking-[0.2em]">Simpan Data Peserta</button>
            </div>
        </div>

        <!-- Tabel Data -->
        <div class="bg-white rounded-xl overflow-hidden border-2 border-gray-100 shadow-sm">
            <div class="p-5 bg-white border-b-2 border-gray-100 flex justify-between items-center">
                <h2 class="font-black text-black uppercase text-xs tracking-widest">Data Peserta Ziarah</h2>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-black text-blue-600 uppercase tracking-tighter italic">Secured by Reydns Ofiicial</span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[11px] uppercase tracking-widest">
                            <th class="p-5 header-bold">Nama & Alamat</th>
                            <th class="p-5 text-right header-bold">Harga Tiket</th>
                            <th class="p-5 text-right header-bold">Dibayar</th>
                            <th class="p-5 text-center header-bold">Status Pembayaran</th>
                            <th class="p-5 text-center admin-panel header-bold">Hapus</th>
                        </tr>
                    </thead>
                    <tbody id="tabelBody" class="divide-y-2 divide-gray-50 text-[14px]">
                        <!-- JS Render -->
                    </tbody>
                </table>
            </div>
            <div id="emptyMsg" class="p-20 text-center text-gray-300 text-xs font-bold uppercase tracking-widest hidden">
                Database Kosong
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvx_MeU43fnoxX2C4FbCVUmtahouwVF8E",
            authDomain: "absensiachmadtoha.firebaseapp.com",
            projectId: "absensiachmadtoha",
            storageBucket: "absensiachmadtoha.firebasestorage.app",
            messagingSenderId: "728127434246",
            appId: "1:728127434246:web:791c40e93c37e2b48c5d87"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let isAdmin = false;

        window.addEventListener('DOMContentLoaded', async () => {
            await signInAnonymously(auth);
            loadCloudData();
            setTimeout(() => document.getElementById('loader').style.display = 'none', 800);
        });

        document.getElementById('authBtn').onclick = () => {
            if(!isAdmin) {
                const p = prompt("Password Admin:");
                if(p === "komusla2025") {
                    isAdmin = true;
                    document.body.classList.add('is-admin');
                    document.getElementById('authBtn').innerText = "KELUAR ADMIN";
                    document.getElementById('authBtn').classList.replace('bg-white', 'bg-red-600');
                    document.getElementById('authBtn').classList.replace('text-blue-800', 'text-white');
                    renderTabel();
                } else if(p !== null) { alert("Salah!"); }
            } else { location.reload(); }
        };

        let localData = [];

        function loadCloudData() {
            const q = query(collection(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                localData = [];
                snapshot.forEach(d => localData.push({id: d.id, ...d.data()}));
                renderTabel();
                updateStats();
            });
        }

        function updateStats() {
            const totalD = localData.reduce((acc, curr) => acc + (curr.bayar || 0), 0);
            const totalT = localData.reduce((acc, curr) => acc + (curr.tagihan || 250000), 0);
            document.getElementById('statTotal').innerText = localData.length;
            document.getElementById('statDana').innerText = formatIDR(totalD);
            document.getElementById('statSisa').innerText = formatIDR(totalT - totalD);
        }

        function renderTabel() {
            const tbody = document.getElementById('tabelBody');
            tbody.innerHTML = '';
            if(localData.length === 0) { document.getElementById('emptyMsg').classList.remove('hidden'); return; }
            document.getElementById('emptyMsg').classList.add('hidden');

            localData.forEach(p => {
                const sisa = (p.tagihan || 250000) - (p.bayar || 0);
                const lunas = sisa <= 0;
                const row = `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="p-5">
                            <div class="row-nama uppercase tracking-tight">${p.nama}</div>
                            <div class="text-[10px] text-gray-400 font-black uppercase tracking-widest">${p.alamat}</div>
                        </td>
                        <td class="p-5 text-right font-bold text-gray-400">${formatIDR(p.tagihan || 250000)}</td>
                        <td class="p-5 text-right">
                            ${isAdmin ? 
                                `<button onclick="editBayar('${p.id}', ${p.bayar})" class="text-blue-700 font-black hover:underline">${formatIDR(p.bayar)}</button>` : 
                                `<span class="row-nominal text-green-700">${formatIDR(p.bayar)}</span>`
                            }
                        </td>
                        <td class="p-5 text-center">
                            <span class="px-4 py-2 rounded-md text-[10px] font-black uppercase tracking-[0.1em] inline-block min-w-[130px] ${lunas ? 'status-lunas' : 'status-belum'}">
                                ${lunas ? 'LUNAS' : 'SISA ' + formatIDR(sisa)}
                            </span>
                        </td>
                        ${isAdmin ? `<td class="p-5 text-center"><button onclick="hapusData('${p.id}')" class="grayscale hover:grayscale-0 opacity-50 hover:opacity-100">üóëÔ∏è</button></td>` : ''}
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function formatIDR(n) { return 'Rp ' + n.toLocaleString('id-ID'); }

        document.getElementById('btnSimpan').onclick = async () => {
            const nama = document.getElementById('inNama').value;
            const alamat = document.getElementById('inAlamat').value;
            const tagihan = Number(document.getElementById('inTagihan').value);
            const bayar = Number(document.getElementById('inBayar').value);
            if(!nama || !alamat) return alert("Data belum lengkap!");
            try {
                await addDoc(collection(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta"), {
                    nama, alamat, tagihan, bayar, createdAt: Date.now()
                });
                document.getElementById('inNama').value = '';
                document.getElementById('inAlamat').value = '';
                document.getElementById('inBayar').value = '0';
            } catch(e) { alert("Error!"); }
        };

        window.editBayar = async (id, current) => {
            const val = prompt("Update Pembayaran:", current);
            if(val !== null && !isNaN(val)) {
                await updateDoc(doc(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta", id), { bayar: Number(val) });
            }
        };

        window.hapusData = async (id) => {
            if(confirm("Hapus data ini?")) {
                await deleteDoc(doc(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta", id));
            }
        };
    </script>
</body>
</html>
