<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Data Ziarah Komusla</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .status-lunas { background-color: #def7ec; color: #03543f; border: 1px solid #84e1bc; }
        .status-belum { background-color: #fde8e8; color: #9b1c1c; border: 1px solid #f8b4b4; }
        .admin-panel { display: none; }
        .is-admin .admin-panel { display: block; }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; justify-content: center;
            align-items: center; z-index: 100;
        }
        /* Style Baris Data */
        .col-tiket { color: #4b5563; font-weight: 700; } 
        .col-bayar { color: #059669; font-weight: 800; }
        .header-bold { font-weight: 900 !important; color: #1f2937 !important; }
    </style>
</head>
<body class="pb-10">

    <!-- Loading Screen -->
    <div id="loader">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-700 mx-auto"></div>
            <p class="mt-4 text-gray-500 font-bold text-xs uppercase tracking-widest">Memuat Data Cloud...</p>
        </div>
    </div>

    <!-- Header Biru Klasik -->
    <header class="bg-blue-700 text-white py-6 shadow-md mb-6">
        <div class="container mx-auto px-4 flex justify-between items-center max-w-4xl">
            <div>
                <h1 class="text-xl font-bold uppercase tracking-tight">Data Peserta Ziarah Komusla</h1>
                <p class="text-xs opacity-80">by Reydns Official (KOMUSLA)</p>
            </div>
            <button id="authBtn" class="bg-yellow-400 text-blue-900 px-4 py-1.5 rounded font-bold text-xs hover:bg-yellow-500 transition shadow">
                LOGIN ADMIN
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 max-w-4xl">
        
        <!-- Dashboard Statistik -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded shadow-sm border-l-4 border-blue-600">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Total Peserta</p>
                <h3 id="statTotal" class="text-2xl font-bold text-gray-800">0</h3>
            </div>
            <div class="bg-white p-4 rounded shadow-sm border-l-4 border-green-600">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Dana Terkumpul</p>
                <h3 id="statDana" class="text-2xl font-bold text-green-700">Rp 0</h3>
            </div>
            <div class="bg-white p-4 rounded shadow-sm border-l-4 border-red-600">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Kekurangan</p>
                <h3 id="statSisa" class="text-2xl font-bold text-red-600">Rp 0</h3>
            </div>
        </div>

        <!-- Form Input -->
        <div id="formSection" class="admin-panel mb-8 animate-in fade-in duration-500">
            <div class="bg-white p-6 rounded shadow-md border-t-4 border-blue-600">
                <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2 uppercase text-sm">Input Peserta</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="inNama" placeholder="Nama Lengkap" class="p-2 border rounded outline-none focus:ring-1 focus:ring-blue-500">
                    <input type="text" id="inAlamat" placeholder="Alamat/Lingkungan" class="p-2 border rounded outline-none focus:ring-1 focus:ring-blue-500">
                    <input type="number" id="inTagihan" value="250000" placeholder="Harga Tiket" class="p-2 border rounded outline-none focus:ring-1 focus:ring-blue-500">
                    <input type="number" id="inBayar" value="0" placeholder="Sudah Dibayar" class="p-2 border rounded outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <button id="btnSimpan" class="mt-4 w-full bg-blue-700 text-white font-bold py-3 rounded hover:bg-blue-800 transition shadow-lg uppercase text-sm tracking-widest">Simpan Data ke Cloud</button>
            </div>
        </div>

        <!-- Tabel Data -->
        <div class="bg-white rounded shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h2 class="font-bold text-gray-700 uppercase text-xs">Daftar Peserta</h2>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-bold text-gray-400">CLOUD SYNC</span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200 text-[12px] text-gray-800 uppercase tracking-wider">
                            <th class="p-4 border-b header-bold">Nama & Alamat</th>
                            <th class="p-4 border-b text-right header-bold">Tiket</th>
                            <th class="p-4 border-b text-right header-bold">Dibayar</th>
                            <th class="p-4 border-b text-center header-bold">Status Sisa</th>
                            <th id="thAksi" class="p-4 border-b text-center admin-panel header-bold">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelBody" class="divide-y text-[13px]">
                        <!-- Data otomatis muncul di sini -->
                    </tbody>
                </table>
            </div>
            <div id="emptyMsg" class="p-10 text-center text-gray-400 text-xs italic hidden">
                Belum ada data peserta tersimpan...
            </div>
        </div>
    </main>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvx_MeU43fnoxX2C4FbCVUmtahouwVF8E",
            authDomain: "absensiachmadtoha.firebaseapp.com",
            projectId: "absensiachmadtoha",
            storageBucket: "absensiachmadtoha.firebasestorage.app",
            messagingSenderId: "728127434246",
            appId: "1:728127434246:web:791c40e93c37e2b48c5d87"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let isAdmin = false;

        window.addEventListener('DOMContentLoaded', async () => {
            await signInAnonymously(auth);
            loadCloudData();
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
        });

        document.getElementById('authBtn').onclick = () => {
            if(!isAdmin) {
                const p = prompt("Masukkan Password Admin:");
                if(p === "komusla2024") {
                    isAdmin = true;
                    document.body.classList.add('is-admin');
                    document.getElementById('authBtn').innerText = "LOGOUT ADMIN";
                    document.getElementById('authBtn').className = "bg-red-500 text-white px-4 py-1.5 rounded font-bold text-xs shadow";
                    renderTabel();
                } else if(p !== null) { alert("Password Salah!"); }
            } else {
                location.reload();
            }
        };

        let localData = [];

        function loadCloudData() {
            const q = query(collection(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                localData = [];
                snapshot.forEach(d => localData.push({id: d.id, ...d.data()}));
                renderTabel();
                updateStats();
            });
        }

        function updateStats() {
            const totalP = localData.length;
            const totalD = localData.reduce((acc, curr) => acc + (curr.bayar || 0), 0);
            const totalT = localData.reduce((acc, curr) => acc + (curr.tagihan || 250000), 0);
            
            document.getElementById('statTotal').innerText = totalP;
            document.getElementById('statDana').innerText = formatIDR(totalD);
            document.getElementById('statSisa').innerText = formatIDR(totalT - totalD);
        }

        function renderTabel() {
            const tbody = document.getElementById('tabelBody');
            tbody.innerHTML = '';
            
            if(localData.length === 0) {
                document.getElementById('emptyMsg').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyMsg').classList.add('hidden');

            localData.forEach(p => {
                const sisa = (p.tagihan || 250000) - (p.bayar || 0);
                const lunas = sisa <= 0;

                const row = `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                        <td class="p-4">
                            <div class="font-extrabold text-gray-900 uppercase leading-tight">${p.nama}</div>
                            <div class="text-[11px] text-gray-500 font-bold uppercase tracking-wide mt-0.5">${p.alamat}</div>
                        </td>
                        <td class="p-4 text-right col-tiket">${formatIDR(p.tagihan || 250000)}</td>
                        <td class="p-4 text-right">
                            ${isAdmin ? 
                                `<button onclick="editBayar('${p.id}', ${p.bayar})" class="col-bayar hover:underline underline-offset-4 decoration-2">${formatIDR(p.bayar)}</button>` : 
                                `<span class="col-bayar">${formatIDR(p.bayar)}</span>`
                            }
                        </td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1.5 rounded text-[11px] font-black uppercase inline-block min-w-[120px] shadow-sm ${lunas ? 'status-lunas' : 'status-belum'}">
                                ${lunas ? 'LUNAS' : 'SISA ' + formatIDR(sisa)}
                            </span>
                        </td>
                        ${isAdmin ? `
                        <td class="p-4 text-center">
                            <button onclick="hapusData('${p.id}')" class="text-red-300 hover:text-red-600 transition-colors text-lg">üóëÔ∏è</button>
                        </td>` : ''}
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function formatIDR(n) {
            return 'Rp ' + n.toLocaleString('id-ID');
        }

        document.getElementById('btnSimpan').onclick = async () => {
            const nama = document.getElementById('inNama').value;
            const alamat = document.getElementById('inAlamat').value;
            const tagihan = Number(document.getElementById('inTagihan').value);
            const bayar = Number(document.getElementById('inBayar').value);

            if(!nama || !alamat) return alert("Isi Nama & Alamat!");

            try {
                await addDoc(collection(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta"), {
                    nama, alamat, tagihan, bayar, createdAt: Date.now()
                });
                document.getElementById('inNama').value = '';
                document.getElementById('inAlamat').value = '';
                document.getElementById('inBayar').value = '0';
            } catch(e) { alert("Gagal Simpan!"); }
        };

        window.editBayar = async (id, current) => {
            if(!isAdmin) return;
            const val = prompt("Update jumlah bayar (masukkan angka saja):", current);
            if(val !== null && !isNaN(val)) {
                await updateDoc(doc(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta", id), {
                    bayar: Number(val)
                });
            }
        };

        window.hapusData = async (id) => {
            if(!isAdmin) return;
            if(confirm("Hapus data peserta ini secara permanen dari cloud?")) {
                await deleteDoc(doc(db, "artifacts", "ziarah-komusla-v2", "public", "data", "peserta", id));
            }
        };
    </script>
</body>
</html>
